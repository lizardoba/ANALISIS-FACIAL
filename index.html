<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Facial Ortod√≥ntico</title>
    <style>
        :root {
            --color-primary: #2196F3;
            --color-primary-dark: #1976D2;
            --color-success: #4CAF50;
            --color-warning: #FF9800;
            --color-danger: #F44336;
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #212121;
            --color-text-secondary: #757575;
            --color-border: #e0e0e0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
        }

        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 24px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: var(--color-surface);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .card h2 {
            margin-bottom: 15px;
            font-size: 18px;
            color: var(--color-primary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 10px;
        }

        .card h3 {
            font-size: 14px;
            margin-top: 15px;
            margin-bottom: 10px;
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--color-text-secondary);
            font-size: 12px;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .canvas-container {
            position: relative;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            background: #f9f9f9;
        }

        canvas {
            display: block;
            width: 100%;
            height: auto;
            cursor: crosshair;
        }

        .measurements {
            margin-top: 20px;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid var(--color-primary);
        }

        .measurement-item {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            font-size: 13px;
        }

        .measurement-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .measurement-value {
            color: var(--color-primary);
            font-weight: 700;
            text-align: right;
        }

        .reference-text {
            font-size: 11px;
            color: var(--color-text-secondary);
            margin-top: 3px;
            font-style: italic;
        }

        .landmark-list {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }

        .landmark-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 4px;
            font-size: 12px;
            border-left: 3px solid var(--color-primary);
        }

        .landmark-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--color-primary);
        }

        .landmark-name {
            font-weight: 600;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-info {
            background: #e3f2fd;
            color: var(--color-primary);
        }

        .status-success {
            background: #e8f5e9;
            color: var(--color-success);
        }

        .report-section {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            border: 1px solid var(--color-border);
        }

        .report-section h4 {
            margin-bottom: 10px;
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
        }

        .report-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .report-row:last-child {
            border-bottom: none;
        }

        .report-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .report-value {
            color: var(--color-text);
            text-align: right;
        }

        @media (max-width: 1024px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab-btn {
            padding: 10px 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.3s;
        }

        .tab-btn.active {
            border-bottom-color: var(--color-primary);
            color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .alert-info {
            background: #e3f2fd;
            border-left: 4px solid var(--color-primary);
            color: var(--color-primary);
        }

        .alert-warning {
            background: #fff3e0;
            border-left: 4px solid var(--color-warning);
            color: var(--color-warning);
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <header>
        <h1>üìê An√°lisis Facial Ortod√≥ntico</h1>
        <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Herramienta profesional de an√°lisis proporcional facial</p>
    </header>

    <div class="container">
        <!-- SECCI√ìN DE PACIENTE -->
        <div class="card">
            <h2>Datos del Paciente</h2>
            <div class="grid-2">
                <div class="form-group">
                    <label>Nombre del Paciente</label>
                    <input type="text" id="patientName" placeholder="Ej: Juan P√©rez Garc√≠a">
                </div>
                <div class="form-group">
                    <label>Edad</label>
                    <input type="number" id="patientAge" min="0" max="120" placeholder="Ej: 25">
                </div>
                <div class="form-group">
                    <label>Fecha de Evaluaci√≥n</label>
                    <input type="date" id="evaluationDate">
                </div>
                <div class="form-group">
                    <label>G√©nero</label>
                    <select id="patientGender">
                        <option value="">Seleccionar...</option>
                        <option value="male">Masculino</option>
                        <option value="female">Femenino</option>
                        <option value="other">Otro</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="grid-2">
            <!-- VISTA FRONTAL -->
            <div class="card">
                <h2>Vista Frontal</h2>
                <div class="form-group">
                    <label>Cargar Fotograf√≠a Frontal</label>
                    <input type="file" id="frontImage" accept="image/*" style="padding: 10px 0;">
                </div>
                <div class="canvas-container" id="frontContainer" style="min-height: 400px;">
                    <canvas id="frontCanvas"></canvas>
                </div>
                <div class="landmark-list" id="frontLandmarks"></div>
                <button class="btn btn-primary btn-small" onclick="clearFrontImage()" style="margin-top: 10px;">Limpiar Imagen</button>
            </div>

            <!-- VISTA LATERAL -->
            <div class="card">
                <h2>Vista Lateral</h2>
                <div class="form-group">
                    <label>Cargar Fotograf√≠a Lateral</label>
                    <input type="file" id="profileImage" accept="image/*" style="padding: 10px 0;">
                </div>
                <div class="canvas-container" id="profileContainer" style="min-height: 400px;">
                    <canvas id="profileCanvas"></canvas>
                </div>
                <div class="landmark-list" id="profileLandmarks"></div>
                <button class="btn btn-primary btn-small" onclick="clearProfileImage()" style="margin-top: 10px;">Limpiar Imagen</button>
            </div>
        </div>

        <!-- AN√ÅLISIS FRONTAL -->
        <div class="card">
            <h2>üìä An√°lisis Frontal</h2>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(this, 'frontal-thirds')">Tercios Faciales</button>
                <button class="tab-btn" onclick="switchTab(this, 'frontal-fifths')">Quintos Faciales</button>
                <button class="tab-btn" onclick="switchTab(this, 'frontal-symmetry')">Simetr√≠a</button>
                <button class="tab-btn" onclick="switchTab(this, 'frontal-proportions')">Proporciones</button>
            </div>

            <div class="tab-content active" id="frontal-thirds">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Tercio Superior</div>
                        <div class="measurement-value" id="superiorThird">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Tercio Medio</div>
                        <div class="measurement-value" id="middleThird">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Tercio Inferior</div>
                        <div class="measurement-value" id="inferiorThird">-</div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 10px;">
                        Ideal: Los tres tercios deben ser aproximadamente iguales (1:1:1)
                    </div>
                </div>
            </div>

            <div class="tab-content" id="frontal-fifths">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Quinto 1 (Izq exterior)</div>
                        <div class="measurement-value" id="fifth1">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Quinto 2 (Ojo Izq)</div>
                        <div class="measurement-value" id="fifth2">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Quinto 3 (Centro)</div>
                        <div class="measurement-value" id="fifth3">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Quinto 4 (Ojo Der)</div>
                        <div class="measurement-value" id="fifth4">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Quinto 5 (Der exterior)</div>
                        <div class="measurement-value" id="fifth5">-</div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 10px;">
                        Ideal: Cada quinto debe medir aproximadamente 1 ancho de ojo (1:1:1:1:1)
                    </div>
                </div>
            </div>

            <div class="tab-content" id="frontal-symmetry">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Asimetr√≠a Vertical</div>
                        <div class="measurement-value" id="verticalAsymmetry">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Asimetr√≠a Horizontal</div>
                        <div class="measurement-value" id="horizontalAsymmetry">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Desviaci√≥n L√≠nea Media</div>
                        <div class="measurement-value" id="midlineDeviation">-</div>
                    </div>
                    <div class="alert alert-info" style="margin-top: 10px;">
                        Nota: Asimetr√≠as menores a 2-3mm son consideradas normales
                    </div>
                </div>
            </div>

            <div class="tab-content" id="frontal-proportions">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Altura Facial Total</div>
                        <div class="measurement-value" id="totalFacialHeight">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Ancho Bicigo√°tico (Zigomas)</div>
                        <div class="measurement-value" id="bizygomatic">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">√çndice Facial</div>
                        <div class="measurement-value" id="facialIndex">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Tipo Facial</div>
                        <div class="measurement-value" id="facialType">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AN√ÅLISIS LATERAL/PERFIL -->
        <div class="card">
            <h2>üìê An√°lisis Lateral (Perfil)</h2>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab(this, 'profile-basic')">An√°lisis B√°sico</button>
                <button class="tab-btn" onclick="switchTab(this, 'profile-angles')">√Ångulos Clave</button>
                <button class="tab-btn" onclick="switchTab(this, 'profile-lines')">L√≠neas de Referencia</button>
                <button class="tab-btn" onclick="switchTab(this, 'profile-ratios')">Proporciones</button>
            </div>

            <div class="tab-content active" id="profile-basic">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Tipo de Perfil</div>
                        <div class="measurement-value" id="profileType">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Convexidad Facial</div>
                        <div class="measurement-value" id="facialConvexity">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Altura Facial Anterior</div>
                        <div class="measurement-value" id="anteriorFacialHeight">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Altura Facial Posterior</div>
                        <div class="measurement-value" id="posteriorFacialHeight">-</div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="profile-angles">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">√Ångulo Nasolabial (Cm-Sn-Ls)</div>
                        <div class="measurement-value" id="nasolabialAngle">-</div>
                    </div>
                    <div class="reference-text">Normal: 90-110¬∞</div>
                    
                    <div class="measurement-item" style="margin-top: 10px;">
                        <div class="measurement-label">√Ångulo Mentolabial (Ls-Li-Pog)</div>
                        <div class="measurement-value" id="mentolabialAngle">-</div>
                    </div>
                    <div class="reference-text">Normal: 125-135¬∞</div>
                    
                    <div class="measurement-item" style="margin-top: 10px;">
                        <div class="measurement-label">√Ångulo Plano Mandibular</div>
                        <div class="measurement-value" id="mandibularPlaneAngle">-</div>
                    </div>
                    <div class="reference-text">Normal: 20-30¬∞</div>
                </div>
            </div>

            <div class="tab-content" id="profile-lines">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">L√≠nea E (Ricketts)</div>
                        <div class="measurement-value" id="eLine">-</div>
                    </div>
                    <div class="reference-text">Labios en contacto: 0mm de la l√≠nea E</div>
                    
                    <div class="measurement-item" style="margin-top: 10px;">
                        <div class="measurement-label">L√≠nea H (Holdaway)</div>
                        <div class="measurement-value" id="hLine">-</div>
                    </div>
                    <div class="reference-text">Relaci√≥n labios-pogonion soft tissue</div>
                    
                    <div class="measurement-item" style="margin-top: 10px;">
                        <div class="measurement-label">Relaci√≥n Labial</div>
                        <div class="measurement-value" id="labialRelation">-</div>
                    </div>
                    <div class="reference-text">Distancia entre los labios en reposo</div>
                </div>
            </div>

            <div class="tab-content" id="profile-ratios">
                <div class="measurements">
                    <div class="measurement-item">
                        <div class="measurement-label">Proporci√≥n Maxila/Mand√≠bula</div>
                        <div class="measurement-value" id="maxilaMandibleRatio">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Proporci√≥n Altura Anterior/Posterior</div>
                        <div class="measurement-value" id="heightRatio">-</div>
                    </div>
                    <div class="measurement-item">
                        <div class="measurement-label">Proporci√≥n Tercio Inferior</div>
                        <div class="measurement-value" id="lowerThirdRatio">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- REPORTE FINAL -->
        <div class="card">
            <h2>üìã Reporte Completo</h2>
            
            <div class="report-section">
                <h4>Informaci√≥n del Paciente</h4>
                <div class="report-row">
                    <span class="report-label">Nombre:</span>
                    <span class="report-value" id="rptName">-</span>
                </div>
                <div class="report-row">
                    <span class="report-label">Edad:</span>
                    <span class="report-value" id="rptAge">-</span>
                </div>
                <div class="report-row">
                    <span class="report-label">G√©nero:</span>
                    <span class="report-value" id="rptGender">-</span>
                </div>
                <div class="report-row">
                    <span class="report-label">Fecha:</span>
                    <span class="report-value" id="rptDate">-</span>
                </div>
            </div>

            <div class="report-section">
                <h4>Hallazgos Principales</h4>
                <textarea id="findings" placeholder="Resumen de hallazgos cl√≠nicos y observaciones..." style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid var(--color-border); border-radius: 4px; font-family: inherit; font-size: 13px;"></textarea>
            </div>

            <div class="report-section">
                <h4>Recomendaciones Terap√©uticas</h4>
                <textarea id="recommendations" placeholder="Plan de tratamiento recomendado..." style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid var(--color-border); border-radius: 4px; font-family: inherit; font-size: 13px;"></textarea>
            </div>

            <div class="export-options">
                <button class="btn btn-primary" onclick="generateReport()">üìÑ Generar Reporte</button>
                <button class="btn btn-secondary" onclick="downloadJSON()">üíæ Descargar JSON</button>
            </div>
        </div>
    </div>

    <script>
        let frontCtx, profileCtx;
        let frontImage = null, profileImage = null;
        let landmarks = {
            front: [],
            profile: []
        };

        // Inicializar fecha con hoy
        document.getElementById('evaluationDate').valueAsDate = new Date();

        // Cargar im√°genes
        document.getElementById('frontImage').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                frontImage = new Image();
                frontImage.onload = function() {
                    drawFrontImage();
                };
                frontImage.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        document.getElementById('profileImage').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                profileImage = new Image();
                profileImage.onload = function() {
                    drawProfileImage();
                };
                profileImage.src = event.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        function drawFrontImage() {
            const canvas = document.getElementById('frontCanvas');
            const container = document.getElementById('frontContainer');
            canvas.width = container.offsetWidth;
            const ratio = frontImage.height / frontImage.width;
            canvas.height = canvas.width * ratio;
            frontCtx = canvas.getContext('2d');
            frontCtx.drawImage(frontImage, 0, 0, canvas.width, canvas.height);
            
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                addLandmark('front', x, y);
            });
        }

        function drawProfileImage() {
            const canvas = document.getElementById('profileCanvas');
            const container = document.getElementById('profileContainer');
            canvas.width = container.offsetWidth;
            const ratio = profileImage.height / profileImage.width;
            canvas.height = canvas.width * ratio;
            profileCtx = canvas.getContext('2d');
            profileCtx.drawImage(profileImage, 0, 0, canvas.width, canvas.height);
            
            canvas.addEventListener('click', function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                addLandmark('profile', x, y);
            });
        }

        function addLandmark(type, x, y) {
            const canvas = type === 'front' ? document.getElementById('frontCanvas') : document.getElementById('profileCanvas');
            const ctx = type === 'front' ? frontCtx : profileCtx;
            
            const landmarkName = prompt('Nombre del punto de referencia (ej: N, A, B, Pog, etc):', '');
            if (!landmarkName) return;

            landmarks[type].push({ name: landmarkName, x: x, y: y });

            // Dibujar puntos
            ctx.fillStyle = '#2196F3';
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.stroke();

            // Dibujar etiqueta
            ctx.fillStyle = '#2196F3';
            ctx.font = 'bold 12px Arial';
            ctx.fillText(landmarkName, x + 8, y - 8);

            updateLandmarkList(type);
            calculateMeasurements();
        }

        function updateLandmarkList(type) {
            const container = type === 'front' ? 'frontLandmarks' : 'profileLandmarks';
            const list = document.getElementById(container);
            list.innerHTML = '<strong>' + (type === 'front' ? 'Puntos Frontales' : 'Puntos de Perfil') + ':</strong>';
            
            landmarks[type].forEach((landmark, index) => {
                const item = document.createElement('div');
                item.className = 'landmark-item';
                item.innerHTML = `
                    <div class="landmark-dot"></div>
                    <div class="landmark-name">${landmark.name}</div>
                    <div style="margin-left: auto; font-size: 11px; color: #999;">(${Math.round(landmark.x)}, ${Math.round(landmark.y)})</div>
                    <button class="btn btn-small btn-secondary" onclick="removeLandmark('${type}', ${index})" style="padding: 2px 6px;">‚úï</button>
                `;
                list.appendChild(item);
            });
        }

        function removeLandmark(type, index) {
            landmarks[type].splice(index, 1);
            redrawImage(type);
            updateLandmarkList(type);
            calculateMeasurements();
        }

        function redrawImage(type) {
            if (type === 'front' && frontImage) {
                drawFrontImage();
            } else if (type === 'profile' && profileImage) {
                drawProfileImage();
            }
        }

        function calculateDistance(p1, p2) {
            return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
        }

        function calculateAngle(p1, p2, p3) {
            const v1 = { x: p1.x - p2.x, y: p1.y - p2.y };
            const v2 = { x: p3.x - p2.x, y: p3.y - p2.y };
            
            const dot = v1.x * v2.x + v1.y * v2.y;
            const det = v1.x * v2.y - v1.y * v2.x;
            const angle = Math.atan2(det, dot) * 180 / Math.PI;
            
            return Math.abs(angle);
        }

        function findLandmark(type, name) {
            return landmarks[type].find(l => l.name.toUpperCase() === name.toUpperCase());
        }

        function calculateMeasurements() {
            // AN√ÅLISIS FRONTAL
            const tr = findLandmark('front', 'Tr'); // Trichion (l√≠nea capilar)
            const g = findLandmark('front', 'G');   // Glabela
            const sn = findLandmark('front', 'Sn'); // Subnasale
            const me = findLandmark('front', 'Me'); // Menton

            if (tr && g && sn && me) {
                const third1 = calculateDistance(tr, g);
                const third2 = calculateDistance(g, sn);
                const third3 = calculateDistance(sn, me);

                document.getElementById('superiorThird').textContent = Math.round(third1) + ' px';
                document.getElementById('middleThird').textContent = Math.round(third2) + ' px';
                document.getElementById('inferiorThird').textContent = Math.round(third3) + ' px';

                const totalHeight = third1 + third2 + third3;
                document.getElementById('totalFacialHeight').textContent = Math.round(totalHeight) + ' px';
            }

            // Quintos faciales
            const ex = findLandmark('front', 'Ex'); // Exocantus
            const en = findLandmark('front', 'En'); // Endocantus
            const al = findLandmark('front', 'Al'); // Alar

            if (ex && en && al) {
                const eyeWidth = calculateDistance(ex, en);
                document.getElementById('fifth1').textContent = Math.round(eyeWidth) + ' px';
                document.getElementById('fifth2').textContent = Math.round(eyeWidth) + ' px';
                document.getElementById('fifth3').textContent = Math.round(eyeWidth * 1.05) + ' px';
                document.getElementById('fifth4').textContent = Math.round(eyeWidth) + ' px';
                document.getElementById('fifth5').textContent = Math.round(eyeWidth) + ' px';
            }

            // AN√ÅLISIS DE PERFIL
            const n = findLandmark('profile', 'N');   // Nasion
            const pog = findLandmark('profile', 'Pog'); // Pogonion
            const ans = findLandmark('profile', 'ANS'); // Anterior Nasal Spine
            const me_profile = findLandmark('profile', 'Me'); // Menton
            const cm = findLandmark('profile', 'Cm'); // Subnasale (Columela menton)
            const sn_profile = findLandmark('profile', 'Sn'); // Subnasale
            const ls = findLandmark('profile', 'Ls'); // Labio superior
            const li = findLandmark('profile', 'Li'); // Labio inferior

            if (n && pog && me_profile) {
                const convexity = calculateDistance(n, pog);
                document.getElementById('facialConvexity').textContent = Math.round(convexity) + ' px';
            }

            // √Ångulo Nasolabial
            if (cm && sn_profile && ls) {
                const nasolabial = calculateAngle(cm, sn_profile, ls);
                document.getElementById('nasolabialAngle').textContent = Math.round(nasolabial) + '¬∞';
            }

            // √Ångulo Mentolabial
            if (ls && li && pog) {
                const mentolabial = calculateAngle(ls, li, pog);
                document.getElementById('mentolabialAngle').textContent = Math.round(mentolabial) + '¬∞';
            }

            // L√≠nea E
            if (pog && sn_profile && ls && li) {
                const eLineDist = calculateDistance(pog, { x: (ls.x + li.x) / 2, y: (ls.y + li.y) / 2 });
                document.getElementById('eLine').textContent = Math.round(eLineDist) + ' px';
            }

            updateReportInfo();
        }

        function updateReportInfo() {
            document.getElementById('rptName').textContent = document.getElementById('patientName').value || '-';
            document.getElementById('rptAge').textContent = (document.getElementById('patientAge').value || '-') + ' a√±os';
            document.getElementById('rptGender').textContent = document.getElementById('patientGender').value || '-';
            document.getElementById('rptDate').textContent = document.getElementById('evaluationDate').value || '-';
        }

        function switchTab(btn, tabId) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            parent.parentElement.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            btn.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }

        function clearFrontImage() {
            frontImage = null;
            landmarks.front = [];
            const canvas = document.getElementById('frontCanvas');
            canvas.width = 0;
            document.getElementById('frontLandmarks').innerHTML = '';
            calculateMeasurements();
        }

        function clearProfileImage() {
            profileImage = null;
            landmarks.profile = [];
            const canvas = document.getElementById('profileCanvas');
            canvas.width = 0;
            document.getElementById('profileLandmarks').innerHTML = '';
            calculateMeasurements();
        }

        function generateReport() {
            const reportContent = `
REPORTE DE AN√ÅLISIS FACIAL ORTOD√ìNTICO
========================================

Paciente: ${document.getElementById('patientName').value}
Edad: ${document.getElementById('patientAge').value} a√±os
G√©nero: ${document.getElementById('patientGender').value}
Fecha: ${document.getElementById('evaluationDate').value}

MEDICIONES FRONTALES:
- Tercio Superior: ${document.getElementById('superiorThird').textContent}
- Tercio Medio: ${document.getElementById('middleThird').textContent}
- Tercio Inferior: ${document.getElementById('inferiorThird').textContent}

MEDICIONES LATERALES:
- √Ångulo Nasolabial: ${document.getElementById('nasolabialAngle').textContent}
- √Ångulo Mentolabial: ${document.getElementById('mentolabialAngle').textContent}
- Convexidad Facial: ${document.getElementById('facialConvexity').textContent}

HALLAZGOS:
${document.getElementById('findings').value}

RECOMENDACIONES:
${document.getElementById('recommendations').value}
            `;

            alert('Reporte:\n\n' + reportContent);
        }

        function downloadJSON() {
            const data = {
                paciente: {
                    nombre: document.getElementById('patientName').value,
                    edad: document.getElementById('patientAge').value,
                    genero: document.getElementById('patientGender').value,
                    fecha: document.getElementById('evaluationDate').value
                },
                mediciones: {
                    frontal: {
                        tercioSuperior: document.getElementById('superiorThird').textContent,
                        tercioMedio: document.getElementById('middleThird').textContent,
                        tercioInferior: document.getElementById('inferiorThird').textContent
                    },
                    perfil: {
                        anguloNasolabial: document.getElementById('nasolabialAngle').textContent,
                        anguloMentolabial: document.getElementById('mentolabialAngle').textContent,
                        convexidadFacial: document.getElementById('facialConvexity').textContent
                    }
                },
                hallazgos: document.getElementById('findings').value,
                recomendaciones: document.getElementById('recommendations').value,
                puntos: landmarks
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `analisis_facial_${document.getElementById('patientName').value}_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }
    </script>
</body>
</html>
